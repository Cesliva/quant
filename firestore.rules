rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // DEVELOPMENT MODE: Open access for testing
    // TODO: Replace with proper authentication rules before production
    match /{document=**} {
      allow read, write: if true;
    }
    
    /* PRODUCTION RULES (commented out for development)
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user belongs to company
    function isCompanyMember(companyId) {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/companies/$(companyId)/members/$(request.auth.uid));
    }
    
    // Helper function to check if user has project access
    function hasProjectAccess(companyId, projectId) {
      return isCompanyMember(companyId) && (
        // User is assigned to project OR
        request.auth.uid in get(/databases/$(database)/documents/companies/$(companyId)/projects/$(projectId)).data.assignedTo ||
        // User is the assigned estimator OR
        request.auth.uid == get(/databases/$(database)/documents/companies/$(companyId)/projects/$(projectId)).data.assignedEstimator ||
        // User has company-wide edit permission (admin or estimator)
        get(/databases/$(database)/documents/companies/$(companyId)/members/$(request.auth.uid)).data.role in ['admin', 'estimator']
      );
    }
    
    // Helper function to check if user can read project (for filtering)
    function canReadProject(companyId, projectId) {
      return isCompanyMember(companyId) && (
        // Admins can always read
        get(/databases/$(database)/documents/companies/$(companyId)/members/$(request.auth.uid)).data.role == 'admin' ||
        // User is assigned to project OR
        request.auth.uid in get(/databases/$(database)/documents/companies/$(companyId)/projects/$(projectId)).data.assignedTo ||
        // User is the assigned estimator
        request.auth.uid == get(/databases/$(database)/documents/companies/$(companyId)/projects/$(projectId)).data.assignedEstimator
      );
    }
    
    // Helper function to check if user can manage users
    function canManageUsers(companyId) {
      return isCompanyMember(companyId) && 
             get(/databases/$(database)/documents/companies/$(companyId)/members/$(request.auth.uid)).data.permissions.canManageUsers == true;
    }
    
    // Helper function to check if user is workspace owner
    function isWorkspaceOwner(companyId) {
      return isCompanyMember(companyId) && 
             get(/databases/$(database)/documents/companies/$(companyId)).data.ownerId == request.auth.uid;
    }
    
    // Helper function to check if user can access settings (owner or admin)
    function canAccessSettings(companyId) {
      if (!isCompanyMember(companyId)) return false;
      let member = get(/databases/$(database)/documents/companies/$(companyId)/members/$(request.auth.uid)).data;
      // Owner always has access
      if (isWorkspaceOwner(companyId)) return true;
      // Admin has access
      return member.role == 'admin' || member.role == 'owner';
    }
    
    // Companies collection
    match /companies/{companyId} {
      // Company document - protect settings field
      allow read: if isCompanyMember(companyId);
      allow create: if isCompanyMember(companyId);
      allow update: if isCompanyMember(companyId) && (
        // If updating settings field, require admin/owner access
        // Allow update if settings field is unchanged OR user has settings access
        !('settings' in request.resource.data) ||
        request.resource.data.settings == resource.data.settings ||
        canAccessSettings(companyId)
      );
      allow delete: if false; // Never allow company deletion via rules
      
      // Legacy catch-all for other document paths
      match /{document=**} {
        allow read, write: if isCompanyMember(companyId);
      }
      
      // Members collection
      match /members/{userId} {
        allow read: if isCompanyMember(companyId);
        allow write: if canManageUsers(companyId) || request.auth.uid == userId;
      }
      
      // Invitations collection
      match /invitations/{invitationId} {
        allow read: if isCompanyMember(companyId);
        allow write: if canManageUsers(companyId);
      }
      
      // Notifications
      match /notifications/{userId}/items/{notificationId} {
        allow read: if request.auth.uid == userId; // Users can only read their own notifications
        allow write: if isCompanyMember(companyId); // Any member can create notifications for others
      }
      
      // Settings - only owner/admin can write
      match /settings/{settingsId} {
        allow read: if isCompanyMember(companyId);
        allow write: if canAccessSettings(companyId);
      }
      
      // Company document - only owner can transfer ownership
      match /{document=**} {
        allow read: if isCompanyMember(companyId);
        allow update: if isCompanyMember(companyId) && 
          (!('ownerId' in request.resource.data) || 
           request.resource.data.ownerId == resource.data.ownerId || 
           isWorkspaceOwner(companyId));
      }
      
      // Projects
      match /projects/{projectId} {
        allow read: if canReadProject(companyId, projectId);
        allow create: if isCompanyMember(companyId) && 
          get(/databases/$(database)/documents/companies/$(companyId)/members/$(request.auth.uid)).data.permissions.canCreateProjects == true;
        allow update: if hasProjectAccess(companyId, projectId);
        allow delete: if isCompanyMember(companyId) && 
          get(/databases/$(database)/documents/companies/$(companyId)/members/$(request.auth.uid)).data.permissions.canDeleteProjects == true;
        
        // Active users (presence tracking)
        match /activeUsers/{userId} {
          allow read: if isCompanyMember(companyId);
          allow write: if request.auth.uid == userId; // Users can only update their own presence
        }
        
        // Locks (edit locking)
        match /locks/{section} {
          allow read: if isCompanyMember(companyId);
          allow write: if isCompanyMember(companyId); // Any member can acquire/release locks
        }
        
        // Activities (activity feed)
        match /activities/{activityId} {
          allow read: if isCompanyMember(companyId);
          allow create: if isCompanyMember(companyId) && request.resource.data.userId == request.auth.uid; // Users can only create their own activities
          allow update, delete: if false; // Activities are immutable
        }
        
        // Comments
        match /comments/{commentPath=**} {
          allow read: if isCompanyMember(companyId);
          allow create: if isCompanyMember(companyId) && request.resource.data.userId == request.auth.uid;
          allow update, delete: if isCompanyMember(companyId) && request.resource.data.userId == request.auth.uid;
        }
        
        // Project subcollections
        match /lines/{lineId} {
          allow read, write: if hasProjectAccess(companyId, projectId);
        }
        
        match /aiLogs/{logId} {
          allow read, write: if hasProjectAccess(companyId, projectId);
        }
        
        match /auditLogs/{auditId} {
          allow read, write: if hasProjectAccess(companyId, projectId);
        }
        
        // Comments
        match /comments/{commentPath=**} {
          allow read: if isCompanyMember(companyId);
          allow create: if isCompanyMember(companyId) && request.resource.data.userId == request.auth.uid;
          allow update, delete: if isCompanyMember(companyId) && request.resource.data.userId == request.auth.uid;
        }
      }
      
      // Notifications
      match /notifications/{userId}/items/{notificationId} {
        allow read: if request.auth.uid == userId; // Users can only read their own notifications
        allow write: if isCompanyMember(companyId); // Any member can create notifications for others
      }
    }
    */
  }
}

